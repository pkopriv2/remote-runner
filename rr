#! /bin/bash

export rr_home
export rr_host_home

rr_home=${rr_home:-$HOME/.rr}
rr_host_home=${rr_host_home:-$rr_home/hosts}

source $rr_home/require.sh

require "lib/login.sh"
require "lib/log.sh"
require "lib/inet.sh"
require "host.sh"
require "key.sh"
require "role.sh"
require "archive.sh"
require "fileserver.sh"
require "runlist.sh"


IFS=$'\n'
execute() {
	if [[ $# < 1 ]]
	then
		log_error "Must provide a host regexp."
		exit 1
	fi

	local host_list=( $( _host_match $1) )
	log_info "Hosts have expanded to: [ ${host_list[*]} ]"

	shift

	for host in "${host_list[@]}"
	do
		(
			log_debug "Building host environment [$host]"
			source_host $host

			for archive in "${archives[@]}"
			do
				log_debug "Executing archive [$archive] on host [$host]"


				#{ 
				#echo "server_ip=$(inet_src_ip "$(login_get_host $1)")"
				#echo "fileserver_port=$fileserver_port"
				#_ssh_lib $3
				#} | ssh -t -i $2 $1 "bash -s"
			done
		) || exit 1




		##fileserver_start $rr_archive_home/$archive/files 

		#log_info "Running archive [$archive]."
		#_ssh "$login" "$key_file" "$archive"

		#fileserver_stop &> /dev/null
	done



}

help() {
	log_error "Undefined"
}


args=($*)
action="${args[0]}"
shift

case "$action" in
	key|host|role|archive)
		"$action"_action "$@"
		;;
	help)
		help
		;;	
	*)
		execute "${args[@]}" 
		;;
esac
