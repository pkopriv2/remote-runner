#! /bin/bash

export rr_home
export rr_host_home

rr_home=${rr_home:-$HOME/.rr}
rr_host_home=${rr_host_home:-$rr_home/hosts}

source $rr_home/require.sh

require "lib/login.sh"
require "lib/log.sh"
require "lib/inet.sh"
require "host.sh"
require "key.sh"
require "role.sh"
require "archive.sh"
require "fileserver.sh"

IFS=$'\n'
execute() {
	_ssh_lib() {
		for script in $rr_home/lib/*.sh
		do
			cat $script
		done

		for script in $rr_home/dsl/*.sh
		do
			cat $script
		done

		for script in $rr_archive_home/$1/scripts/*.sh
		do
			cat $script
		done
		
		cat "$rr_host_home/$login.sh"
	}

	_ssh() {
		{ 
			echo "server_ip=$(inet_src_ip "$(login_get_host $1)")"
			echo "fileserver_port=$fileserver_port"
			_ssh_lib $3
		} | ssh -t -i $2 $1 "bash -s"
	}

	_ssh_sudo() {
		printf "%s" "[sudo] password for $USER:"
		read -s password

		echo "$password"
		{ 
			echo "$password"
			echo "$(_ssh_lib)"
			cat $3
		} | ssh -t -i $2 $1 "sudo -S bash -s"
	}

	if [[ $# < 1 ]]
	then
		log_error "Not enough arguments."
		exit 1
	fi

	if [[ "$1" == "sudo" ]]
	then
		local login=$2
		local archive_regexp=$3
	else
		local login=$1
		local archive_regexp=$2
	fi 

	local login=$(login "$login")
	if ! source $rr_host_home/$login.sh
	then
		log_error "Error sourcing client file [$login]."
		exit 1
	fi

	local key_file=$rr_key_home/id_rsa.${key_name:-"default"}
	if [[ ! -f $key_file ]] 
	then 
		log_error "That key file [$key_file] doesn't exist"
		exit 1
	fi

	archives_list=$(_archive_list) 
	for archive in "${archives_list[@]}" 
	do
		if expr "$archive" : "$archive_regexp" > /dev/null
		then
			log_info "Running archive [$archive]."

			fileserver_start $rr_archive_home/$archive/files 

			if [[ "$1" == "sudo" ]]
			then
				_ssh_sudo "$login" "$key_file" "$archive"
			else
				_ssh "$login" "$key_file" "$archive"
			fi

			fileserver_stop > /dev/null
		fi
	done
}

help() {
	log_error "Undefined"
}


args=($*)
action="${args[0]}"
shift

case "$action" in
	key|host|role|archive)
		"$action"_action "$@"
		;;
	help)
		help
		;;	
	*)
		execute "${args[@]}" 
		;;
esac
